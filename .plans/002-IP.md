# Custom Domain & Blog Subscription - Implementation Plan

**Master Plan:** `.plans/002-MP.md`
**Date:** 2025-12-25

---

## Overview

This implementation plan provides file-by-file code changes for configuring a custom domain (nicharena.com) on GitHub Pages and adding email subscriptions via Buttondown.

**Buttondown username:** `nicharena`

---

## Proposed Structure

### Guiding Principles
- Use existing CSS variables for consistent styling
- Keep form simple - Buttondown handles everything server-side
- No JavaScript required for form submission
- Maintain dark/light mode compatibility

---

## File-by-File Change List

### File 1: `CNAME` (new)

**Path:** `/CNAME`

**Change:** Create new file in repository root.

```
nicharena.com
```

**Why:** GitHub Pages requires a CNAME file to serve the site at a custom domain. This file tells GitHub which domain to associate with the repository.

---

### File 2: `astro.config.mjs` (modify)

**Path:** `/astro.config.mjs`

**Change:** Update site URL from GitHub Pages subdomain to custom domain.

**Before:**
```javascript
export default defineConfig({
  site: 'https://niarenaw.github.io',
```

**After:**
```javascript
export default defineConfig({
  site: 'https://nicharena.com',
```

**Why:** Astro uses the `site` config for generating canonical URLs, sitemaps, and RSS feeds. Must match the actual deployed domain.

---

### File 3: `src/components/SubscribeForm.astro` (new)

**Path:** `/src/components/SubscribeForm.astro`

**Change:** Create new component for email subscription form.

```astro
---
// SubscribeForm.astro
// Email subscription form using Buttondown
---

<section class="mt-16 pt-8 border-t border-[var(--color-border)]">
    <h2 class="text-xl font-semibold mb-3 text-[var(--color-accent)]">
        Subscribe
    </h2>
    <p class="text-[var(--color-text-muted)] mb-4">
        Get notified when I publish new posts. No spam, unsubscribe anytime.
    </p>
    <form
        action="https://buttondown.email/api/emails/embed-subscribe/nicharena"
        method="post"
        class="flex gap-3"
    >
        <input
            type="email"
            name="email"
            placeholder="your@email.com"
            required
            class="flex-1 px-4 py-2 rounded-lg border border-[var(--color-border)] bg-[var(--color-bg)] text-[var(--color-text)] placeholder-[var(--color-text-muted)] focus:outline-none focus:border-[var(--color-accent)]"
        />
        <button
            type="submit"
            class="px-6 py-2 rounded-lg bg-[var(--color-accent)] text-white font-medium hover:bg-[var(--color-accent-hover)] transition-colors"
        >
            Subscribe
        </button>
    </form>
</section>
```

**Why:**
- Uses Buttondown's embed form POST endpoint - no backend needed
- Styled with existing CSS variables for dark/light mode support
- Flexbox layout keeps input and button on same line
- Form submits directly to Buttondown, which handles confirmation emails

---

### File 4: `src/pages/blog/index.astro` (modify)

**Path:** `/src/pages/blog/index.astro`

**Change:** Import and add SubscribeForm component below post list.

**Before (lines 1-4):**
```astro
---
import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
```

**After (lines 1-5):**
```astro
---
import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import SubscribeForm from "../../components/SubscribeForm.astro";
```

**Before (lines 60-65):**
```astro
                </ul>
            )
        }
    </div>
</BaseLayout>
```

**After (lines 60-67):**
```astro
                </ul>
            )
        }

        <SubscribeForm />
    </div>
</BaseLayout>
```

**Why:** Places subscription form at the bottom of the blog index page, after the post list. The form appears in context where readers are already browsing content.

---

### File 5: `README.md` (modify)

**Path:** `/README.md`

**Change:** Add notification workflow documentation section.

**Append to end of file:**

```markdown

## Notifying Subscribers

When publishing a **new** blog post (not edits to existing posts):

1. Push the new post to `main` branch
2. Wait for deployment to complete
3. Go to [Buttondown dashboard](https://buttondown.email/emails)
4. Click "New email"
5. Write notification:
   ```
   Subject: New post: [Post Title]

   Body:
   I just published a new post: [Post Title]

   [Brief 1-2 sentence description]

   Read it here: https://nicharena.com/blog/[slug]
   ```
6. Preview and send

**Important:** Only notify for new posts. Edits to existing posts (typos, clarifications) do not warrant notifications.
```

**Why:** Documents the manual notification workflow. Explicitly states that only new posts trigger notifications - edits don't spam subscribers.

---

## Task List with Checkboxes

### Ticket #1: Purchase Domain & Configure DNS (External)
- [ ] 1.1 Purchase nicharena.com from Cloudflare
- [ ] 1.2 Add A records for apex domain (4 GitHub IPs) with "DNS only" mode
  - 185.199.108.153
  - 185.199.109.153
  - 185.199.110.153
  - 185.199.111.153
- [ ] 1.3 Add CNAME record for www → niarenaw.github.io with "DNS only" mode
- [ ] 1.4 Verify DNS propagation with `dig nicharena.com`

### Ticket #2: Configure GitHub Pages Custom Domain
- [ ] 2.1 Create `CNAME` file in repository root
- [ ] 2.2 Update `astro.config.mjs` site URL to `https://nicharena.com`
- [ ] 2.3 Push changes to main
- [ ] 2.4 Enable custom domain in GitHub repo Settings → Pages
- [ ] 2.5 Enable "Enforce HTTPS" once certificate provisions
- [ ] 2.6 Verify site loads at https://nicharena.com
- [ ] 2.7 Verify https://www.nicharena.com redirects correctly
- [ ] 2.8 Verify old niarenaw.github.io redirects to new domain

### Ticket #3: Create Buttondown Account (External)
- [ ] 3.1 Create account at buttondown.email
- [ ] 3.2 Configure newsletter name and description
- [ ] 3.3 Note username for embed form URL
- [ ] 3.4 Test subscription with personal email
- [ ] 3.5 Verify embed URL uses username `nicharena`

### Ticket #4: Add Subscribe Form to Blog Index
- [ ] 4.1 Create `src/components/SubscribeForm.astro`
- [ ] 4.2 Update `src/pages/blog/index.astro` to import and use component
- [ ] 4.3 Test form styling in light mode
- [ ] 4.4 Test form styling in dark mode
- [ ] 4.5 Test form submission to Buttondown
- [ ] 4.6 Verify confirmation email received

### Ticket #5: Add Subscriber Count Display (Optional)
- [ ] 5.1 Check if Buttondown free tier exposes subscriber count
- [ ] 5.2 If available, add count display to SubscribeForm
- [ ] 5.3 If not available, skip this ticket

### Ticket #6: Document Notification Workflow
- [ ] 6.1 Add "Notifying Subscribers" section to README.md
- [ ] 6.2 Include template email content
- [ ] 6.3 Clearly distinguish new posts vs edits

---

## Open Questions + Risk Areas

1. **Buttondown Username:** `nicharena` - account created, embed URL ready.

2. **DNS Propagation:** May take up to 48 hours after Cloudflare DNS changes. GitHub Pages won't provision SSL until DNS resolves correctly.

3. **Cloudflare Proxy Mode:** Must use "DNS only" (gray cloud), not "Proxied" (orange cloud). Proxied mode interferes with GitHub Pages SSL certificates.

4. **Subscriber Count API:** Need to verify if Buttondown free tier provides access. If not, Ticket #5 will be skipped.
